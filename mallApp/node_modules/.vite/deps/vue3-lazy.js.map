{
  "version": 3,
  "sources": ["../../vue3-lazy/src/types/index.ts", "../../vue3-lazy/src/helpers/dom.ts", "../../vue3-lazy/src/helpers/loadImage.ts", "../../vue3-lazy/src/helpers/debug.ts", "../../vue3-lazy/src/core/imageManager.ts", "../../vue3-lazy/src/helpers/util.ts", "../../vue3-lazy/src/core/lazy.ts", "../../vue3-lazy/src/index.ts"],
  "sourcesContent": ["export enum State {\n  loading,\n  loaded,\n  error\n}\n\nexport interface LazyOptions {\n  error?: string\n  loading?: string\n}\n\nexport interface ImageManagerOptions {\n  el: HTMLElement\n  parent: HTMLElement | Window\n  src: string\n  error: string\n  loading: string\n  cache: Set<string>\n}\n\nexport interface Target {\n  el: HTMLElement | Window\n  ref: number\n}\n\n", "const inBrowser = typeof window !== 'undefined'\n\nexport const hasIntersectionObserver = checkIntersectionObserver()\n\nfunction checkIntersectionObserver (): boolean {\n  if (inBrowser &&\n    'IntersectionObserver' in window &&\n    'IntersectionObserverEntry' in window &&\n    'intersectionRatio' in IntersectionObserverEntry.prototype) {\n    // Minimal polyfill for Edge 15's lack of `isIntersecting`\n    // See: https://github.com/w3c/IntersectionObserver/issues/211\n    if (!('isIntersecting' in IntersectionObserverEntry.prototype)) {\n      Object.defineProperty(IntersectionObserverEntry.prototype,\n        'isIntersecting', {\n          get: function (this: IntersectionObserverEntry) {\n            return this.intersectionRatio > 0\n          }\n        })\n    }\n    return true\n  }\n  return false\n}\n\nconst style = (el: HTMLElement, prop: string): string => {\n  return getComputedStyle(el).getPropertyValue(prop)\n}\n\nconst overflow = (el: HTMLElement): string => {\n  return style(el, 'overflow') + style(el, 'overflow-y') + style(el, 'overflow-x')\n}\n\nexport function scrollParent (el: HTMLElement): HTMLElement | Window {\n  let parent = el\n\n  while (parent) {\n    if (parent === document.body || parent === document.documentElement) {\n      break\n    }\n\n    if (!parent.parentNode) {\n      break\n    }\n\n    if (/(scroll|auto)/.test(overflow(parent))) {\n      return parent\n    }\n\n    parent = parent.parentNode as HTMLElement\n  }\n\n  return window\n}\n", "export default function loadImage (src: string): Promise<any> {\n  return new Promise((resolve, reject) => {\n    const image = new Image()\n\n    image.onload = function () {\n      resolve()\n      dispose()\n    }\n\n    image.onerror = function (e) {\n      reject(e)\n      dispose()\n    }\n\n    image.src = src\n\n    function dispose () {\n      image.onload = image.onerror = null\n    }\n  })\n}\n", "export function warn (msg: string): void {\n  console.warn(`[Vue3-lazy warn]: ${msg}`)\n}\n", "import { ImageManagerOptions, State } from '../types'\nimport loadImage from '../helpers/loadImage'\nimport { warn } from '../helpers/debug'\n\nexport default class ImageManager {\n  el: HTMLElement\n  parent: HTMLElement | Window\n  src: string\n  error: string\n  loading: string\n  cache: Set<string>\n  state: State\n\n  constructor (options: ImageManagerOptions) {\n    this.el = options.el\n    this.parent = options.parent\n    this.src = options.src\n    this.error = options.error\n    this.loading = options.loading\n    this.cache = options.cache\n    this.state = State.loading\n\n    this.render(this.loading)\n  }\n\n  load (next?: Function): void {\n    if (this.state > State.loading) {\n      return\n    }\n    if (this.cache.has(this.src)) {\n      this.state = State.loaded\n      this.render(this.src)\n      return\n    }\n    this.renderSrc(next)\n  }\n\n  isInView (): boolean {\n    const rect = this.el.getBoundingClientRect()\n    return rect.top < window.innerHeight && rect.left < window.innerWidth\n  }\n\n  update (src: string): void {\n    const currentSrc = this.src\n    if (src !== currentSrc) {\n      this.src = src\n      this.state = State.loading\n    }\n  }\n\n  private renderSrc (next?: Function): void {\n    loadImage(this.src).then(() => {\n      this.state = State.loaded\n      this.render(this.src)\n      this.cache.add(this.src)\n      next && next()\n    }).catch((e) => {\n      this.state = State.error\n      this.render(this.error)\n      warn(`load failed with src image(${this.src}) and the error msg is ${e.message}`)\n      next && next()\n    })\n  }\n\n  private render (src: string): void {\n    this.el.setAttribute('src', src)\n  }\n}\n", "export function throttle (fn: Function, delay: number): Function {\n  let timeout = 0\n  let lastRun = 0\n  return function (this: void) {\n    if (timeout) {\n      return\n    }\n    const elapsed = Date.now() - lastRun\n    const context = this\n    const args = arguments\n    const runCallback = function () {\n      lastRun = Date.now()\n      timeout = 0\n      fn.apply(context, args)\n    }\n    if (elapsed >= delay) {\n      runCallback()\n    } else {\n      timeout = window.setTimeout(runCallback, delay)\n    }\n  }\n}\n", "import { DirectiveBinding } from 'vue'\nimport { LazyOptions, State, Target } from '../types'\nimport { hasIntersectionObserver, scrollParent } from '../helpers/dom'\nimport ImageManager from './imageManager'\nimport { throttle } from '../helpers/util'\n\nconst DEFAULT_URL = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'\n\nconst events = ['scroll', 'wheel', 'mousewheel', 'resize', 'animationend', 'transitionend', 'touchmove', 'transitioncancel']\n\nconst THROTTLE_DELAY = 300\n\nexport default class Lazy {\n  error: string\n  loading: string\n  cache: Set<string>\n  managerQueue: ImageManager[]\n  observer?: IntersectionObserver\n  targetQueue?: Target[]\n  throttleLazyHandler: Function\n\n  constructor (options: LazyOptions) {\n    this.error = options.error || DEFAULT_URL\n    this.loading = options.loading || DEFAULT_URL\n\n    this.cache = new Set()\n    this.managerQueue = []\n    this.throttleLazyHandler = throttle(this.lazyHandler.bind(this), THROTTLE_DELAY)\n\n    this.init()\n  }\n\n  add (el: HTMLElement, binding: DirectiveBinding): void {\n    const src = binding.value\n    const parent = scrollParent(el)\n\n    const manager = new ImageManager({\n      el,\n      parent,\n      src,\n      error: this.error,\n      loading: this.loading,\n      cache: this.cache\n    })\n\n    this.managerQueue.push(manager)\n\n    if (hasIntersectionObserver) {\n      this.observer!.observe(el)\n    } else {\n      this.addListenerTarget(parent)\n      this.addListenerTarget(window)\n      this.throttleLazyHandler()\n    }\n  }\n\n  update (el: HTMLElement, binding: DirectiveBinding): void {\n    const src = binding.value\n    const manager = this.managerQueue.find((manager) => {\n      return manager.el === el\n    })\n    if (manager) {\n      manager.update(src)\n    }\n  }\n\n  remove (el: HTMLElement): void {\n    const manager = this.managerQueue.find((manager) => {\n      return manager.el === el\n    })\n    if (manager) {\n      this.removeManager(manager)\n    }\n  }\n\n  private init (): void {\n    if (hasIntersectionObserver) {\n      this.initIntersectionObserver()\n    } else {\n      this.targetQueue = []\n    }\n  }\n\n  private initIntersectionObserver (): void {\n    this.observer = new IntersectionObserver((entries) => {\n      entries.forEach((entry) => {\n        if (entry.isIntersecting) {\n          const manager = this.managerQueue.find((manager) => {\n            return manager.el === entry.target\n          })\n          if (manager) {\n            if (manager.state === State.loaded) {\n              this.removeManager(manager)\n              return\n            }\n            manager.load()\n          }\n        }\n      })\n    }, {\n      rootMargin: '0px',\n      threshold: 0\n    })\n  }\n\n  private addListenerTarget (el: HTMLElement | Window): void {\n    let target = this.targetQueue!.find((target) => {\n      return target.el === el\n    })\n\n    if (!target) {\n      target = {\n        el,\n        ref: 1\n      }\n      this.targetQueue!.push(target)\n      this.addListener(el)\n    } else {\n      target.ref++\n    }\n  }\n\n  private removeListenerTarget (el: HTMLElement | Window): void {\n    this.targetQueue!.some((target, index) => {\n      if (el === target.el) {\n        target.ref--\n        if (!target.ref) {\n          this.removeListener(el)\n          this.targetQueue!.splice(index, 1)\n        }\n        return true\n      }\n      return false\n    })\n  }\n\n  private addListener (el: HTMLElement | Window): void {\n    events.forEach((event) => {\n      el.addEventListener(event, this.throttleLazyHandler as EventListenerOrEventListenerObject, {\n        passive: true,\n        capture: false\n      })\n    })\n  }\n\n  private removeListener (el: HTMLElement | Window): void {\n    events.forEach((event) => {\n      el.removeEventListener(event, this.throttleLazyHandler as EventListenerOrEventListenerObject)\n    })\n  }\n\n  private lazyHandler (e: Event): void {\n    for (let i = this.managerQueue.length - 1; i >= 0; i--) {\n      const manager = this.managerQueue[i]\n      if (manager.isInView()) {\n        if (manager.state === State.loaded) {\n          this.removeManager(manager)\n          return\n        }\n        manager.load()\n      }\n    }\n  }\n\n  private removeManager (manager: ImageManager): void {\n    const index = this.managerQueue.indexOf(manager)\n    if (index > -1) {\n      this.managerQueue.splice(index, 1)\n    }\n    if (this.observer) {\n      this.observer.unobserve(manager.el)\n    } else {\n      this.removeListenerTarget(manager.parent)\n      this.removeListenerTarget(window)\n    }\n  }\n}\n", "import { App } from 'vue'\nimport { LazyOptions } from './types'\nimport Lazy from './core/lazy'\n\nconst lazyPlugin = {\n  install (app: App, options: LazyOptions) {\n    const lazy = new Lazy(options)\n\n    app.directive('lazy', {\n      mounted: lazy.add.bind(lazy),\n      updated: lazy.update.bind(lazy),\n      unmounted: lazy.update.bind(lazy)\n    })\n  }\n}\n\nexport default lazyPlugin\n"],
  "mappings": "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",
  "names": ["State", "ImageManager", "Lazy", "manager", "target"]
}
